\section{Inverse Kinematics}

With the forward kinematic equations, the position of the end effector can be determined relative to the base frame for given values of the joint variables.
In the context of robotics, it is also necessary to determine these joint variables for a given end effector position.
This is referred to as the inverse kinematic problem.
Solving the inverse kinematic problem for a given serial link actuator allows to transform a motion plan of the \ac{EOAT} into joint actuator trajectories for the robot.\\
\\
\subsection{Existence of solutions} \label{ExistSol}
To determine the joint values for a \ac{EOAT}-position it needs to be determined, if there exists a solution.
Not all positions are equally reachable.
There are two types of workspace(\cite{craig1986introduction}, ch4, p.102):
\begin{itemize}[wide=\parindent] 
	\item[\textbf{Dextrous workspace}] volume of space that the robot end-effector can reach with all orientations
	\item[\textbf{reachable workspace}] volume of space, that the robot can reach in at least one orientation
\end{itemize}


A manipulator with less than 6\ac{DOF} cannot reach all positions and orientations in 3D-space. Further limitations can be imposed by the axis alignment. A planar manipulator for example cannot reach  out of the plane. \cite{craig1986introduction}

\subsection{multiple solutions} \label{MultipSol}
A 6\ac{DOF} robot has multiple sets of inverse solutions. To understand why there are multiple solutions, it helps to have a look at fig. \ref{fig:multipSol3Link}. The same end effector position and orientation can be reached in two ways by a 3-link manipulator. 

\begin{figure}[H]
	\includegraphics[
	width=1\linewidth,
	center,
	keepaspectratio,
	]{invKin/Multip_Sol}
	\caption{Three link manipulator with 2 solutions (see \cite{craig1986introduction}, p.103 )}
	\label{fig:multipSol3Link}
\end{figure}

This can be extended to the 6\ac{DOF} serial link manipulators.
As stated by YanWu et al. there are 8 groups of inverse solution for most \ac{EOAT}-positions within the manipulator's workspace \cite{invKinSolYanWu}. 

\begin{figure}[H]
	\includegraphics[
	width=1\linewidth,
	center,
	keepaspectratio,
	]{invKin/TreeOfInvserseSolution}
	\caption{Tree of inverse solutions (\cite{invKinSolYanWu}, fig.2)}
	\label{fig:invKinTree}
\end{figure}
%
The tree of inverse solutions shown in figure \ref{fig:invKinTree} is a schematic representation of different possible solutions. It does not show actual positions. A set of the different joint configurations for inverse solutions in the Fanuc can be found in \fullref{sec:RobConf}.


\subsection{Inverse solution of 6 \ac{DOF} Robot}

As shown in chapter \ref{ForKinEq} the end effector position is defined by four $3 \times 1$ vectors $ (n,o,a,p) $. With these known, the joint variables $(\theta_1, \theta_2, \theta_3, \theta_4, \theta_5, \theta_6)$ can be calculated.
This problem  is solved by the method of using the inverse transformation of unknown link pre-multiplication as presented by Yan Wu et al. \cite{invKinSolYanWu}. 

\paragraph{Forward kinematic equation}
For a  6\ac{DOF} Robot, the  forward kinematic matrix equation from equation \cref{eq:SummofTranfMatr,eq:matrixForm} can be reformulated into equation \ref{eq:ForwKinEquMatr}

\begin{equation}\label{eq:ForwKinEquMatr}
	^0_6T = \\
	\begin{bmatrix}
n_x & o_x & a_x & p_x \\
n_y & o_y & a_y & p_y \\
n_z & o_z & a_z & p_z \\
0 & 0 & 0 & 1 \\
\end{bmatrix}
=
\phantom{}^0_1T(\theta_1)\phantom{}^1_2T(\theta_2)\phantom{}^2_3T(\theta_3)\phantom{}^3_4T(\theta_4)\phantom{}^4_5T(\theta_5)\phantom{}^5_6T(\theta_6)\\
\end{equation}

\subsection{The inverse Solution} \label{InverseSol}
With $ (n,o,a,p) $ known, the angle values of the joint variables can be determined by separation of the joint variables. 
In a first step eq. \ref{eq:ForwKinEquMatr} is reformed into eq. \ref{eq:ForwKinEquMatr_reformed}.
\begin{equation}\label{eq:ForwKinEquMatr_reformed}
	\phantom{}^2T_3\phantom{}^3T_4\phantom{}^4T_5 = \phantom{}^0T_6(\phantom{}^0T_1)^{-1}(\phantom{}^1T_2)^{-1}(\phantom{}^5T_6)^{-1}
\end{equation}
This gives 2 matrices, formed by the terms found in eq. \ref{eq:TransformMatrices_0-6}. These matrices are the terms found in eq. \ref{eq:ForwKinEquMatr_reformed}.
With the help of MATLAB and the symbolic toolbox, the inverses and the overall product of each side can be calculated. %should be done for actual confirmation. Test it!

	\input{ThesisWork/BackKinematics/Prelinkmultip}


As shown by eq. \ref{eq:ForwKinEquMatr_reformed}, the elements of matrices \cref{eq:prelinkmultip_right,eq:prelinkmultip_left} are corresponding equal. This allows to find analytic expressions for all $\theta_i$. As stated in section \ref{MultipSol}, there are two solutions for each $\theta_i$.
\medskip


\paragraph{$\theta_1$:}

By taking the elements (\textcolor{green}{3},\textcolor{red}{4}) of equations \cref{eq:prelinkmultip_right,eq:prelinkmultip_left} as corresponding equal, equation \ref{eq:equal_3-4} is formed.
\begin{equation}\label{eq:equal_3-4}
	-(-s_1a_x + c_1 a_y )d_6 - s_1 p_x +c_1 p_y = 0
\end{equation}
Reforming equation \ref{eq:equal_3-4} gives a solution for $\theta_1$ as seen in equation \ref{eq:sol_theta_1}.
\begin{multline}\label{eq:sol_theta_1}
	\theta_{1_1} = \atantwo ( p_y - a_y d_6 , p_x - a_x d_6) 
	\phantom{......}
	\theta_{1_2} = \atantwo (-p_y + a_y d_6 ,-p_x + a_x d_6) 
\end{multline}
\medskip

\paragraph{$\theta_2$:}

Taking elements (\textcolor{green}{1},\textcolor{red}{4}) and (\textcolor{green}{2},\textcolor{red}{4}) of equations \cref{eq:prelinkmultip_right,eq:prelinkmultip_left} as corresponding equal, equations \ref{eq:equal_1-4} and \ref{eq:equal_2-4} are formed.
\begin{equation}\label{eq:equal_1-4}
	a_3 c_3 - d_4 s_3 + a_2 = - (c_2 c_1 a_x + c_2 s_1 a_y -s_2 a_z)d_6 + c_2 c_1 p_x + c_2 s_1 p_y -s_2 p_z -c_2 a_1
\end{equation}
\begin{equation}\label{eq:equal_2-4}
	a_3 s_3 +d_4 c_3 = - (- s_2 c_1 a_x - s_2 s_1 a_y - c_2 a_z)d_6 s_2 c_1 p_x s_2 s_1 p_y  -c_2 p_z +s_2 a_1
\end{equation}
For simplification of the terms in equations \cref{eq:equal_1-4,eq:equal_2-4}, middle variables are chosen:
\begin{equation}
	u=c_1 (p_x d_6 a_x ) + s_1 (p_y -a_y d_6)-a_1 \phantom[...]
	v= p_z - a_z d_6
\end{equation}

With these middle variables equations \cref{eq:equal_1-4,eq:equal_2-4} can be rewritten as seen in \cref{eq:equal_1-4_midVar,eq:equal_2-4_midVar}.
\begin{equation}\label{eq:equal_1-4_midVar}
	a_3 c_3 - d_4 s_3 = c_2 u -s_2 v -a_2 
\end{equation}
\begin{equation}\label{eq:equal_2-4_midVar}
	a_3 s_3 + d_4 c_3 = - s_ u - c_2 v
\end{equation}
To eliminate $s_3$ and $c_3$ equations \cref{eq:equal_1-4_midVar,eq:equal_2-4_midVar} are squared and then added to form \ref{eq:1-4+2_4}.
\begin{equation}\label{eq:1-4+2_4}
	a_3^2 +d_4^2 = u^2 +v^2 - 2a_2 c_2 u + 2a_2 s_2 v +a_2^2
\end{equation}
\begin{equation}\label{eq:1-4+2_4_reformed}
	\frac{a_3^2 + d_4^2 - u^2 - v^2 -a_2^2}{-2a_2}= c_2 u -s_2 v
\end{equation}
This equation can be further simplified by taking another middle variable:
\begin{equation*}
	m = \frac{a_3^2 +d_4^2 - u^1 -v^2 - a_2^2}{-2a_2}
\end{equation*}
Reforming equation \ref{eq:1-4+2_4_reformed} and inserting the middle variable reveals a solution for $\theta_2$ as seen in eq\ref{eq:sol_theta_2}.
\begin{equation}\label{eq:sol_theta_2}
	\theta_{2_{1/2}} = \atantwo (-v , u)\pm \atantwo(\sqrt{v^2 +u^2 - m^2 } , m)
\end{equation}



\paragraph{$\theta_3$:}

To recive $\theta_3$ it helps to take equations \cref{eq:equal_1-4,eq:equal_2-4}. Equation \ref{eq:equal_1-4} needs to be reformed into \ref{eq:eqal_1-4_reformed}
\begin{equation} \label{eq:eqal_1-4_reformed}
	a_c c_3 d_4 s_3 + a_2 = c_2 u -s_2 v
\end{equation}
Squaring of equations \cref{eq:eqal_1-4_reformed,eq:equal_2-4} and adding them eliminates $s_2$ and $c_2$ as seen in eq \ref{eq:1-4_reformed+2_4}
\begin{equation}\label{eq:1-4_reformed+2_4}
	a_2^2 + a_3^2 +d_4^2 + 2 a_2(a_3 c_3 -d_4 s_3) = u^2 + v^2
\end{equation}
\begin{equation}\label{eq:1-4_reformed+2_4_reformed}
	a_3 c_3 - d_4 s_3 = \frac{a_3^2 + d_4^2 - u^2 -v^2 +a_2^2}{2a_2}
\end{equation}

Again, this equation can be further simplified by taking another middle variable:
\begin{equation*}
	-\frac{a_3^2 + d_4^2 - u^2 -v^2 + a_2^2}{2a_2}
\end{equation*}

Reforming equation \ref{eq:1-4_reformed+2_4_reformed} and inserting the middle variable reveals a solution for $\theta_3$ as seen in eq\ref{eq:sol_theta_3}.
\begin{equation}\label{eq:sol_theta_3}
	\theta_{3_{1/2}} = \atantwo(-d_4 , a_3) \pm A \tan (2 (\sqrt{d_4^2 +a_3^2 -h^2} , h))
\end{equation}


\paragraph{$\theta_5$:}
Taking elements (\textcolor{green}{2},\textcolor{red}{2}) and (\textcolor{green}{1},\textcolor{red}{2}) of equations \cref{eq:prelinkmultip_right,eq:prelinkmultip_left} as corresponding equal, equations \ref{eq:equal_2-2} and \ref{eq:equal_1-2} are formed.

\begin{equation}\label{eq:equal_2-2}
	-s_3 c_4 s_5 + c_3 c_5 = -c_1 s_2 a_x - s_1 s_2 a_y -c_2 a_z
\end{equation}
\begin{equation}\label{eq:equal_1-2}
	-c_3 c_4 s_5 - s_3 c_4 = c_1 c_2 a_x + s_1 c_2 a_y - s_2 a_z
\end{equation}

To combine equations \cref{eq:equal_2-2,eq:equal_1-2}, eq \ref{eq:equal_2-2} is multiplied with $c_3$ and eq \ref{eq:equal_1-2} is multiplied by $ s_2$. The resulting equations are then subtracted from each other giving eq \ref{eq:2-2+1-2}.
\begin{equation}\label{eq:2-2+1-2}
	c_5 = (-c_1 s_2 a_x - s_1 s_2 a_y -c_2 a_z) c_3 - (c_1 c_2 a_x +s_1 c_2 a_y - s_2 a_z) s_3
\end{equation}
Reforming equation \ref{eq:2-2+1-2} gives a solution for $\theta_5$ as seen in equation \ref{eq:sol_theta_5}.
\begin{equation}\label{eq:sol_theta_5}
	\theta_{5_{1/2}} = \pm \acos [ ( -c_1 s_2 a_x - s_1 s_2 a_y - c_2 a_z) c_3 - (c_1 c_2 a_x + s_1 c_2 a_y - s_2 a_z) s_3]
\end{equation}

\paragraph{$\theta_4$:}

With $\theta_5$ and $\theta_{1-3}$ known, equation \ref{eq:equal_1-2} can be reformed into a solution for $\theta_4$ as seen in equation \ref{eq:sol_theta_4}
\begin{equation}\label{eq:sol_theta_4}
	\theta_{4_{1/}} = \pm \arccos [ \frac{ c_1 c_2 a_x + s_1 c_2 a_y - s_2 a_z + s_3 c_5}{-c_3 s_5}]
\end{equation}

\paragraph{$\theta_6$:}
By taking the elements (\textcolor{green}{3},\textcolor{red}{3}) of equations \cref{eq:prelinkmultip_right,eq:prelinkmultip_left} as corresponding equal, equation \ref{eq:equal_3-3} is formed.
\begin{equation} \label{eq:equal_3-3}
	s_6 (s_1 n_x - c_1 n_y) + c_6 (s_1 o_x - c_1 o_y ) = c_4
\end{equation}

With $\theta_4$ and $\theta_1$ known, equation \ref{eq:equal_3-3} can be reformed into a solution for $\theta_6$ as seen in equation \ref{eq:sol_theta_6}.
\begin{equation}\label{eq:sol_theta_6}
	\theta_{6_{1/2}} = \atantwo(s_1 n_x -c_1 n_y , s_1 o_x -c_1 o_y) \pm \atantwo(\sqrt{(s_1 n_x - c_1 n_y)^2 + (s_1 o_x - c_1 o_y )^2 - c_4^2} , c_4)
\end{equation}
\medskip
With equations \cref{eq:sol_theta_1,eq:sol_theta_2,eq:sol_theta_3,eq:sol_theta_4,eq:sol_theta_5,eq:sol_theta_6} the values for $(\theta_1, \theta_2, \theta_3, \theta_4, \theta_5, \theta_6)$ can be calculated for all reachable end effector positions.\\
\medskip
For details on the \gls{atan2} function, see the glossary.
\medskip


\subsection{Optimization of inverse kinematics solution}

As stated in section \ref{MultipSol}, there exist eight sets of inverse solutions in the dextrous workspace (see \ref{ExistSol}).
The optimal set of solutions can be found through an optimization function. 
This optimization function needs to find the set of solution that can reach the desired position fastest from the current position.\\
\\
\paragraph{cost function}
Equation \ref{eq:costFuncinvOptim} is the cost function to be minimized.
\begin{itemize}[wide=\parindent] 
	\item[$\theta_i (k+1)$:] target angle
	\item[$\theta_i(k)$:] departing angle
	\item[$k_i$:] power value
\end{itemize}

\begin{equation}\label{eq:costFuncinvOptim}
	err =  \min\sum_{i=1}^{6} k_i [\theta_i (k+1) - \theta_i(k)] 
\end{equation}

As can be seen, this cost function minimizes the sum of angles over all axes for the movement of the end effector from position $[n_i,o_i,a_i,p_i ]$ to $[n_{i+1}, o_{i+1}, a_{i+1}, p_{i+1}]$ by using the inverse solution presented in chapter \ref{InverseSol}.

\paragraph{limitations of cost function}
This cost function not necessarily gives the fastest path, as it does not account for the actual movement speed of the different axes. 
A possible solution for this would require multiplying with a cost factor between 0 and 1 for each joint ( 1 for the slowest joint) with the respective angle error to account for the difference in angular velocity.



\paragraph{description of implementation}

An implementation of this function receives the current position either in joint angles or Cartesian coordinates of the end-effector which could be given in form of a rotation matrix as seen in eq\ref{eq:matrixForm} or in form of euclidean space and euler angle coordinates. $[x,y,z, \alpha, \beta, \gamma]$ which could be transformed by the inverse of equation \ref{eq:rotMatrix_composition} into a rotation matrix.

This algorithm would then start the calculation to get all possible paths in the tree of inverse solutions (see figure \ref{fig:invKinTree}) for position ${i+1}$.

\paragraph{algorithm for minimal computational effort}

To minimize the computational effort, following algorithm is proposed by Yan Wu et al. \cite{invKinSolYanWu}:

\begin{enumerate}
	\item The calculation starts with $\theta_1$ by finding the two solutions for equation \ref{eq:sol_theta_1}.
	\item When calculating $\theta_2$:
	\begin{enumerate}
		\item  The term $ v^2 + u^2 - m^2 $ should be $ > 0$, otherwise the program can terminate the calculation of the subsequent steps of this group, return $err = inf $ or $NaN $ , and provide a varible like $P=1$ to determine the cause for the abortion of subsequent steps.
		\item If there is a solution for $\theta_2$ it needs to be tested for extraneous roots. An extraneous root is  introduced into an equation in the process of solving another equation, but is not a solution of the equation to be solved \cite{extraneousroot}. This test is done simply by substituting the solution for $\theta_2$ into the original equation \ref{eq:1-4+2_4}. If an extraneous root is found, the program can terminate and return $err = inf$ or $ NaN$  and $P=2$ for cause of abortion. 
	\end{enumerate}
	\item If the calculation has been continued, $\theta_3$ can be determined. Again a test for extraneous roots is necessary.
	\item When calculating $\theta_5$, test for extraneous roots.
	\item When calculating $\theta_4$, test for extraneous roots.
	\item calculate $\theta_6$
	\item determine error as seen in eq \ref{eq:costFuncinvOptim} for all possible paths
	\item find $\min ( err(t_1^8))$ 
\end{enumerate}

The resulting set of angle values is the result of the algorithm. It is the unique inverse solution, determined easiest to reach with the given cost function in eq \ref{eq:costFuncinvOptim}. 





%https://robotics.stackexchange.com/questions/10322/is-it-possible-to-get-all-possible-solutions-of-verse-kinematics-of-a-6-dof-ar
%In general, if the wrist is spherical (i.e., all three axes intersect), you can enumerate all of the various closed-form solutions through a method known as wrist partitioning. This method uses the three arm joints to solve for the position of the wrist center. It then uses the wrist joints to determine the joint angles which orient the end effector properly. Multiple solutions are possible from "wrist up" and "wrist down" options, "elbow up" and "elbow down" options (for an articulated arm), and "over the shoulder" options also. For other robot geometries the options would differ.

%If the wrist is not spherical, it becomes quite challenging to find a closed-form inverse solution. But you still have the various geometric options for inverse kinematics solutions.
%
%One way to make sure you are identifying all of the solutions is to recall the fundamentals of trigonometry. Recall that sin(θ)=−sin(−θ)
%and cos(θ)=cos(−θ). So when you are solving for θ you have to consider the other angles which produce the same result using these and other trigonometric identities. 